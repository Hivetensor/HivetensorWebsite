name: Deploy Backend to DigitalOcean

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
      - '.do/app.yaml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        cd backend
        pip install -r requirements.txt
        
    - name: Run tests
      run: |
        cd backend
        # Add test commands here when tests are implemented
        echo "Tests would run here"
        
    - name: Update DigitalOcean App (Git-based deployment)
      run: |
        # Install doctl
        cd ~
        wget https://github.com/digitalocean/doctl/releases/download/v1.104.0/doctl-1.104.0-linux-amd64.tar.gz
        tar xf ~/doctl-1.104.0-linux-amd64.tar.gz
        sudo mv ~/doctl /usr/local/bin
        
        # Authenticate with DigitalOcean
        doctl auth init -t ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
        
        # Update app spec to use main branch
        cd ${{ github.workspace }}
        sed -i 's/branch: be-integr/branch: main/' .do/app.yaml
        
        # Apply the updated app spec
        doctl apps update fe5bf413-b4f1-45f3-aaeb-b8f8605dc3c8 --spec .do/app.yaml
        
        echo "âœ… App updated! DigitalOcean will now pull from main branch and rebuild automatically." 